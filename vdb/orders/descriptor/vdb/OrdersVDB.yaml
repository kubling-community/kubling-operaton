---
name: "Orders"
version: "1.0"

dataSources:

  - name: "payments"
    dataSourceType: "SCRIPT_DOCUMENT_JS"
    configObject:
      module:
        zipFilePath: "{{ MODULE_BUNDLE }}"
      softTransactions:
        enabled: true
        strategy: {{ STX_STRATEGY }}
        mvcc:
          enabled: {{ MVCC_ENABLED }}
          dbBasePath: "{{ MVCC_BASE_PATH }}"
    schema:
      type: "PHYSICAL"
      ddlFilePaths:
        - "bundle:ddl/payments.sql"

  - name: "issues"
    dataSourceType: "SCRIPT_DOCUMENT_JS"
    configObject:
      module:
        zipFilePath: "{{ MODULE_BUNDLE }}"
      softTransactions: 
        enabled: true
        strategy: {{ STX_STRATEGY }}
        mvcc:
          enabled: {{ MVCC_ENABLED }}
          dbBasePath: "{{ MVCC_BASE_PATH }}"
    schema:
      type: "PHYSICAL"
      ddlFilePaths:
        - "bundle:ddl/issues.sql"

  - name: "inventory"
    dataSourceType: "EMBEDDED_INMEM"
    configObject:
      dataSourceName: "inventory"
      databaseName: "inventory"
      userName: "sa"
      token: "sa"
      maxConnectionPoolSize: 5
      minConnectionPoolSize: 1
      maxConnectionIdleMilliseconds: 7200000
      maxConnectionLifeTimeMilliseconds: 14400000
      cache:
        enabled: false
        ttlSeconds: 43200
      softTransactions: 
        enabled: true
        # Important:
        # For the inventory data source, operations should be accumulated in Kubling and
        # executed as a single batch using one connection.
        #
        # Using IMMEDIATE_OPERATION would hold a database connection open for the entire
        # duration of the Kubling transaction, which is not recommended for this data source.
        strategy: DEFER_OPERATION
        mvcc:
          enabled: {{ MVCC_ENABLED }}
          dbBasePath: "{{ MVCC_BASE_PATH }}"
      contributesToHealth: false
      allowBruteForceOperations: false
      ddlFilePaths:
        - "bundle:ddl/h2/inventory.sql"
    schema:
      type: "PHYSICAL"
      properties:
        importer.useCatalogName: "false"
        importer.useFullSchemaName: "false"
        importer.schemaName: "PUBLIC"
      cacheDefaultStrategy: "NO_CACHE"

  - name: "orders"
    dataSourceType: "EMBEDDED_INMEM"
    configObject:
      dataSourceName: "orders"
      databaseName: "orders"
      userName: "sa"
      token: "sa"
      maxConnectionPoolSize: 5
      minConnectionPoolSize: 1
      maxConnectionIdleMilliseconds: 7200000
      maxConnectionLifeTimeMilliseconds: 14400000
      cache:
        enabled: false
        ttlSeconds: 43200
      softTransactions: 
        enabled: true
        # Beware:
        # IMMEDIATE_OPERATION means that Kubling relies on the remote data source's
        # transactional capabilities and retains the connection until the Kubling
        # transaction completes.
        #
        # In this case, since Orders is the central and authoritative data source,
        # this approach is recommended, as it delegates transaction management
        # to a single, centralized system of record.
        strategy: IMMEDIATE_OPERATION
      contributesToHealth: false
      allowBruteForceOperations: false
      ddlFilePaths:
        - "bundle:ddl/h2/orders.sql"
    schema:
      type: "PHYSICAL"
      properties:
        importer.useCatalogName: "false"
        importer.useFullSchemaName: "false"
        importer.schemaName: "PUBLIC"
      cacheDefaultStrategy: "NO_CACHE"